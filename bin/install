#!/usr/bin/env bash

declare -A oses=(
  ["osx"]="Darwin")
declare -A defaults=(
  ["os"]="${MDS_OS:-`uname`}"
  ["workdir"]="/tmp/mds/tools"
  ["tools"]="${MDS_TOOLCHAIN:-kubernetes-helm,kubefwd,pgcli}"
  ["bootstrap"]="${MDS_BOOTSTRAP:-helm,istio}"
  ["install"]="${MDS_INSTALL:-helm,istio,mds}"
  ["test"]="${MDS_TEST:-unit,integration}"
  ["uninstall"]="${MDS_UNINSTALL:-bookinfo,logging,mds,istio,helm}"
  ["forward"]="${MDS_FORWARD:-default}"
  ["token"]="${MDS_TOKEN:-dashboard}"
  ["reinstall"]="${MDS_REINSTALL:-helm,istio,mds}"
  ["pause"]="${MDS_PAUSE:-5}"
  ["istioVersion"]="${MDS_ISTIO_VERSION:-1.2.5}"
  ["istio"]="${MDS_ISTIO_PATH:-${defaults[workdir]}/istio-${defaults[istioVersion]}}")
declare -A repos=(
  ["stable"]="https://kubernetes-charts.storage.googleapis.com"
  ["banzaicloud-stable"]="https://kubernetes-charts.banzaicloud.com"
  ["elastic"]="https://helm.elastic.co"
  ["istio.io"]="https://storage.googleapis.com/istio-release/releases/1.2.5/charts")
declare -A apps=(
  ["dashboard"]="https://kubernetes-dashboard"
  ["kibana"]="http://kibana:5601"
  ["prometheus"]="http://prometheus:9090"
  ["jaeger"]="http://tracing"
  ["kiali"]="http://kiali:20001"
  ["bookinfo"]="http://productpage:9080")
yellow=`tput setaf 3`
red=`tput setaf 9`
reset=`tput sgr0`

warn() {
  echo "${yellow}warn: ${1}${reset}"
}

error() {
  echo "${red}warn: ${1}${reset}"
}

usage() {
  [ "${1}" ] && warn "${1}"

  cat << EOF
usage: $(basename ${0}) [commands]

commands:
  bootstrap                                           : install dependencies; default: ${defaults[tools]},${defaults[bootstrap]}
  build                                               : build project
  install[:{service[,{service}]}]                     : install specified service; default: ${defaults[install]}
  forward[:{namespace[,{namespace}]}]                 : regisgter service host names in the provided namespace(s); default: ${defaults[forward]}
  forward[:{namepace[/{service[,{service}]}]}         : regisgter service host names in the provided service(s) namespace
  unforward                                           : deregisgter service host names
  test[:unit,integration]                             : preform specified tests; default: ${defaults[test]}
  token[:dashboard]                                   : get specified token, copied to copy-paste buffer for ${oses[osx]}; default: ${defaults[token]}
  open:[app[,{app}]]                                  : opens a browser for the provided application(s)
  cli:[postgresql,redis]                              : create a cli console for the provided service
  uninstall[:{service[,{service}]}]                   : uninstall specified service(s); default: ${defaults[uninstall]}
  reinstall[:{service[,{service}]}]                   : reinstall specified service(s); default: ${defaults[reinstall]}
  help                                                : help message

where namespace in:
    default
    kube-system
    istio-system
    logging
    bookinfo-app

where service in:
    helm
    dashboard
    istio
    mds
    logging
    bookinfo

where app in:
    dashboard                                         : kubernetes dashboard; see https://github.com/kubernetes/dashboard
    kibana                                            : kibana; see https://www.elastic.co/products/kibana
    prometheus                                        : prometheus; see https://prometheus.io
    jaeger                                            : jaeger; see https://www.jaegertracing.io
    kiali                                             : kiali; see https://www.kiali.io
    bookinfo                                          : bookinfo; see https://istio.io/docs/examples/bookinfo

example:
  % ./bin/$(basename ${0}) bootstrap build install:dashboard,mds forward:kube-system/dashboard open:dashhboard test:integration

pre-requisites:
  docker desktop with kubernetes                      : see https://www.docker.com/products/docker-desktop
  bash 4.x                                            : see https://www.gnu.org/software/bash/
  homebrew                                            : see https://brew.sh
  yarn                                                : see https://yarnpkg.com/en/
  nvm                                                 : see https://nvm.sh
  lerna                                               : see https://lerna.js.org
EOF

  [ "${1}" ] && exit 1 || exit 0
}

bootstrap() {
  case "${defaults[os]}" in
    ${oses[osx]})
      if ! hash brew > /dev/null 2>&1; then
        /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
      fi
      brew bundle --file=$(dirname ${0})/Brewfile || usage "brew bundle failed";;
    *) usage "unsupported os: ${defaults[os]}";;
  esac

  # todo: boostrap all-the-things

  for y in cypress mocha chai mochawesome; do
    # if [ $(yarn ${y} --version > /dev/null 2>&1) ]; then
    $(yarn ${y} --version > /dev/null 2>&1)
    (( $? != 0 )) && yarn add -W ${y}
  done

  invoke install "$(normalize ${defaults[bootstrap]})"
}

build()  {
  check ${FUNCNAME[0]}

  for c in clean "" build image; do
    yarn ${c}
  done
}

pause() {
  sleepTime=${1:-${defaults[pause]}}
  cntr=0

  echo -ne "waiting "

  while (( cntr < ${sleepTime} )); do
    echo -ne "\xF0\x9F\x8D\xBA "
    sleep 3
    cntr=$(($cntr + 3))
  done

  echo ""
}

installHelm() {
  if ! hash helm > /dev/null 2>&1 ; then
    case "${defaults[os]}" in
      ${oses[osx]}) brew install kubernetes-helm;;
      *) usage "unsupported os: ${defaults[os]}";;
    esac
  fi

  helm init || usage "helm intialization failure"

  for r in "${!repos[@]}"; do
    helm repo add ${r} ${repos[${r}]}
  done

  for d in $(find ./charts -type d -depth 1 > /dev/null 2>&1); do
    (cd charts/$(basename ${d}); helm dependency update)
  done

  [[ $(helm plugin list | grep unittest) ]] || helm plugin install https://github.com/lrills/helm-unittest
}

installDashboard() {
  check ${FUNCNAME[0]}
  kubectl apply -f \
    https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
  kubectl apply -f charts/dashboard
  helm install --name dahsboard ./charts/dashboard
  # fixme: validate 'install:dashboard' and remove
#   cat <<EOF | kubectl apply -f - || echo "kubernetes dashboard installation failure"
# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   name: admin-user
#   namespace: kube-system
# ---
# apiVersion: rbac.authorization.k8s.io/v1
# kind: ClusterRoleBinding
# metadata:
#   name: admin-user
# roleRef:
#   apiGroup: rbac.authorization.k8s.io
#   kind: ClusterRole
#   name: cluster-admin
# subjects:
# - kind: ServiceAccount
#   name: admin-user
#   namespace: kube-system
# EOF
}

installIstio() {
  check ${FUNCNAME[0]}

  if [ ! -d ${defaults[istio]} ]; then
    mkdir -p ${defaults[workdir]}
    (cd ${defaults[workdir]}; curl -L https://git.io/getLatestIstio | ISTIO_VERSION=${defaults[istioVersion]} sh -)
  fi

  ${defaults[istio]}/bin/istioctl verify-install || warn "istio verify installation failure"

  [[ $(kubectl get namespace istio-system > /dev/null 2>&1) ]] || {
    kubectl create namespace istio-system
    # todo: make kialia|jaeger|grapha install optional
    helm template ${defaults[istio]}/install/kubernetes/helm/istio-init \
      --name istio-init \
      --namespace istio-system | \
      kubectl apply -f -
    pause
    (( $(kubectl -n istio-sytem get crds | grep "istio.io" | wc -l) == 23 )) && \
      echo "istio successfully installed" || usage "istio instllation failure"

    helm template ${defaults[istio]}/install/kubernetes/helm/istio \
      --name istio \
      --namespace istio-system \
      --set tracing.enabled=true \
      --values ${defaults[istio]}/install/kubernetes/helm/istio/values-istio-demo.yaml | \
      kubectl apply -f -
    kubectl label namespace default istio-injection=enabled --overwrite=true
  }
}

installLogging() {
  helm install --name logging --namespace logging ./charts/logging
}

installMds() {
  check ${FUNCNAME[0]}

  [[ $(kubectl get namespace mds > /dev/null 2>&1) ]] || {
    kubectl create secret generic pg-pass --from-literal 'postgresql-password=Password123#'
    helm install --name mds --namespace mds ./charts/mds
  }
}

installBookinfo() {
  check ${FUNCNAME[0]}

  [[ $(kubectl get namespace bookinfo-app > /dev/null 2>&1) ]] || {
    kubectl create namespace bookinfo-app
    kubectl label namespace bookinfo-app istio-injection=enabled --overwrite=true
    kubectl apply -n bookinfo-app -f ${defaults[istio]}/samples/bookinfo/platform/kube/bookinfo.yaml
    kubectl apply -n bookinfo-app -f ${defaults[istio]}/samples/bookinfo/networking/destination-rule-all.yaml
  }
}

forward() {
  check ${FUNCNAME[0]}

  # todo: cleanup
  for ns in ${@}; do
    if [[ ${ns} == *"/"* ]]; then
      app=$(echo "${ns}" | cut -d '/' -f 2)
      n=$(echo "${ns}" | cut -d '/' -f 1)
      for a in $(echo ${app} | tr ',' ' '); do
        sudo --background kubefwd services -n ${n} -l app=${a}
      done
    else
      for n in $(echo ${ns} | tr ',' ' '); do
        sudo --background kubefwd services -n ${n}
      done
    fi
  done
}

unforward() {
  # todo: support kill-by-service/app
  sudo pkill kubefwd
}

testUnit() {
  check ${FUNCNAME[0]}

  # fixme: make mds unit tests work
  # yarn test

  for c in $(find ./charts -type d -depth 1); do
    helm unittest ./charts/$(basename ${c})
  done
}

testIntegration() {
  check ${FUNCNAME[0]}

  # todo: provide [ ui | cli ] option
  # yarn cypress open
  yarn cypress run
}

tokenDashboard() {
  case "${defaults[os]}" in
    ${oses[osx]}) kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | \
      grep admin-user | awk '{print $1}') | grep ^token | cut -d: -f2 | tr -d '[:space:]' | \
      pbcopy;;
    *) kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | \
      grep admin-user | awk '{print $1}') | grep ^token | cut -d: -f2 | tr -d '[:space:]';;
  esac
}

app() {
  for a in ${1}; do
    if [ ${apps[${a}]+_} ]; then
      case "${defaults[os]}" in
        ${oses[osx]}) echo "open ${apps[${a}]}";;
        *) usage "unsupported os: ${defaults[os]}";;
      esac
    else
      usage "unknown application: ${a}"
    fi
  done
}

cliPostgresql() {
  check ${FUNCNAME[0]}
  pgcli postgres://mdsadmin@mds-postgresql:5432/mds
}

cliRedis() {
  check ${FUNCNAME[0]}
  redis-cli -u redis://mds-redis-master:6379/0
}

uninstalllNamespaces() {
  for ns in ${@}; do
    [[ $(kubectl get namespace ${1} > /dev/null 2>&1) ]] && kubectl delete namespace ${ns}
  done
}

uninstallBookinfo() {
  uninstalllNamespaces bookinfo-app
}

uninstallMds() {
  check ${FUNCNAME[0]}
  helm delete --purge mds
}

uninstallLogging() {
  check ${FUNCNAME[0]}
  helm delete --purge logging
}

uninstallIstio() {
  [[ $(kubectl get namespace istio-system > /dev/null 2>&1) ]] && {
    check ${FUNCNAME[0]}
    helm template ${defaults[istio]}/install/kubernetes/helm/istio \
      --name istio \
      --namespace istio-system \
      --values ${defaults[istio]}/install/kubernetes/helm/istio/values-istio-demo.yaml | \
        kubectl delete -f -
    kubectl delete namespace istio-system
    kubectl delete -f ${defaults[istio]}/install/kubernetes/helm/istio-init/files
  }
}

uninstallDashboard() {
  kubectl delete deployment kubernetes-dashboard --namespace=kube-system
  kubectl delete service kubernetes-dashboard  --namespace=kube-system
  kubectl delete role kubernetes-dashboard-minimal --namespace=kube-system
  kubectl delete rolebinding kubernetes-dashboard-minimal --namespace=kube-system
  kubectl delete sa kubernetes-dashboard --namespace=kube-system
  kubectl delete secret kubernetes-dashboard-certs --namespace=kube-system
  kubectl delete secret kubernetes-dashboard-key-holder --namespace=kube-system
}

uninstallHelm() {
  case "${defaults[os]}" in
    ${oses[osx]}) brew uninstall kubernetes-helm;;
    *) usage "unsupported os: ${defaults[os]}";;
  esac
}

check() {
  case "${1}" in
    build | testIntegration)
      hash yarn > /dev/null 2>&1 || bootstrap;;
    installHelm | installBookinfo) ;;
    installDashboard | installIstio | installLogging | installMds | testUnit | \
      uninstallMds | uninstallLogging | uninstallIstio)
      hash helm > /dev/null 2>&1 || installHelm;;
    forward) hash kubefwd  > /dev/null 2>&1 || bootstrap;;
    cliPostgresql) hash pgcli  > /dev/null 2>&1 || bootstrap;;
    cliRedis) hash redis-cli  > /dev/null 2>&1 || bootstrap;;
  esac
}

invoke() {
  for arg in ${2}; do
    ${1}${arg^} || warn "${1} error: ${arg}"
  done
}

normalize() {
  echo ${1} | cut -d ':' -f 2- | tr ',' ' '
}

[[ ! -d ${defaults[workdir]} ]] && mkdir -p ${defaults[workdir]}

if [[ ${#} != 0 ]]; then
  for arg in "${@}"; do
    case "${arg}" in
      bootstrap) bootstrap || warn  "${arg} failure";;
      build) build || usage "${arg} failure";;
      install) arg="${defaults[install]}";&
      install:*) invoke install "$(normalize ${arg})";;
      forward) arg="${defaults[forward]}";&
      forward:*) forward "$(echo ${arg} | cut -d ':' -f 2-)";;
      unforward) unforward;;
      test) arg="${defaults[test]}";&
      test:*) invoke test "$(normalize ${arg})";;
      token) arg="${defaults[token]}";&
      token:*) invoke token "$(normalize ${arg})";;
      open:*) app "$(normalize ${arg})";;
      cli:*) invoke cli "$(normalize ${arg})";;
      uninstall) arg="${defaults[uninstall]}";&
      uninstall:*) invoke uninstall "$(normalize ${arg})";;
      reinstall) arg="${defaults[reinstall]}";&
      reinstall:*)
        invoke uninstall "$(normalize ${arg})"
        invoke install "$(normalize ${arg})";;
      help) usage;;
      *) usage "unknown command: ${arg}"
    esac
  done
else
  usage
fi